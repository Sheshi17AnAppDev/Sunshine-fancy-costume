document.addEventListener('DOMContentLoaded', async () => {
    const usersBody = document.getElementById('users-body');
    const searchInput = document.getElementById('user-search');
    const sortFilter = document.getElementById('sort-filter');

    let allUsers = [];

    async function fetchUsers() {
        try {
            allUsers = await api.get('/admin/users/report');
            renderUsers();
        } catch (error) {
            console.error('Error fetching user report:', error);
        }
    }

    function renderUsers() {
        let filtered = allUsers.filter(u =>
            u.name.toLowerCase().includes(searchInput.value.toLowerCase()) ||
            u.email.toLowerCase().includes(searchInput.value.toLowerCase())
        );

        // Sort logic
        const sortVal = sortFilter.value;
        if (sortVal === 'spent') filtered.sort((a, b) => b.totalSpent - a.totalSpent);
        else if (sortVal === 'orders') filtered.sort((a, b) => b.orderCount - a.orderCount);
        else if (sortVal === 'newest') filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        else if (sortVal === 'oldest') filtered.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

        usersBody.innerHTML = filtered.map(u => `
            <tr>
                <td><strong>${u.name}</strong></td>
                <td>${u.email}</td>
                <td>${new Date(u.createdAt).toLocaleDateString()}</td>
                <td>${u.orderCount}</td>
                <td>â‚¹${u.totalSpent.toLocaleString('en-IN')}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="generateUserBill('${u._id}', '${u.name}')">
                        <i class="fa-solid fa-file-invoice"></i> Bill
                    </button>
                </td>
            </tr>
        `).join('');
    }

    window.generateUserBill = async (userId, userName) => {
        try {
            const orders = await api.get(`/admin/users/${userId}/orders`);
            if (!orders || orders.length === 0) {
                alert('No orders found for this user.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(22);
            doc.setTextColor(251, 176, 59); // Primary Orange
            doc.text("SUNSHINE FANCY COSTUMES", 14, 25);

            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text("Customer Statement / Activity Report", 14, 32);
            doc.text(`Customer: ${userName}`, 14, 37);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 42);

            // Table
            const tableColumn = ["Order ID", "Date", "Status", "Items", "Total (INR)"];
            const tableRows = [];

            let grandTotal = 0;

            orders.forEach(order => {
                const status = order.isDelivered ? 'Delivered' : (order.isPaid ? 'Paid' : 'Pending');
                grandTotal += (order.totalPrice || 0);

                const rowData = [
                    order._id.slice(-8).toUpperCase(),
                    new Date(order.createdAt).toLocaleDateString(),
                    status,
                    order.orderItems.length,
                    (order.totalPrice || 0).toLocaleString('en-IN')
                ];
                tableRows.push(rowData);
            });

            doc.autoTable(tableColumn, tableRows, {
                startY: 50,
                headStyles: { fillColor: [251, 176, 59] },
                alternateRowStyles: { fillColor: [250, 250, 250] }
            });

            const finalY = doc.lastAutoTable.finalY + 10;

            // Summary
            doc.setFontSize(12);
            doc.setTextColor(0);
            doc.setFont(undefined, 'bold');
            doc.text(`Lifetime Total Orders: ${orders.length}`, 14, finalY);
            doc.text(`Lifetime Total Spent: INR ${grandTotal.toLocaleString('en-IN')}`, 14, finalY + 7);

            // Footer
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(150);
            doc.text("Generated by Sunshine Admin System", 105, finalY + 30, { align: 'center' });

            doc.save(`statement_${userName.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`);
        } catch (err) {
            console.error('Bill Generation Error:', err);
            alert('Failed to generate bill: ' + err.message);
        }
    };

    searchInput.addEventListener('input', renderUsers);
    sortFilter.addEventListener('change', renderUsers);

    // Export CSV
    document.getElementById('export-csv').onclick = () => {
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Name,Email,Join Date,Orders,Total Spent\n";

        allUsers.forEach(u => {
            csvContent += `"${u.name}","${u.email}","${new Date(u.createdAt).toLocaleDateString()}",${u.orderCount},${u.totalSpent}\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `user_report_${new Date().toISOString().slice(0, 10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    // Export PDF Report
    document.getElementById('export-pdf').onclick = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(20);
        doc.text("Sunshine Costumes - User Report", 14, 22);
        doc.setFontSize(11);
        doc.setTextColor(100);
        doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 30);

        const tableColumn = ["Name", "Email", "Join Date", "Orders", "Spent (INR)"];
        const tableRows = [];

        allUsers.forEach(u => {
            const rowData = [
                u.name,
                u.email,
                new Date(u.createdAt).toLocaleDateString(),
                u.orderCount,
                u.totalSpent.toLocaleString('en-IN')
            ];
            tableRows.push(rowData);
        });

        doc.autoTable(tableColumn, tableRows, { startY: 40 });
        doc.save(`user_report_${new Date().toISOString().slice(0, 10)}.pdf`);
    };

    fetchUsers();

    // Auto-refresh every 30 seconds
    setInterval(fetchUsers, 30000);
});
